// ==========================================
// SushiWave Database Schema
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Enums
// ==========================================

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  ONLINE
}

// ==========================================
// Models
// ==========================================

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  firstName String   @map("first_name") @db.VarChar(100)
  lastName  String   @map("last_name") @db.VarChar(100)
  phone     String?  @db.VarChar(20)
  address   String?  @db.Text
  role      UserRole @default(USER)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  orders    Order[]
  refreshTokens RefreshToken[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.Text
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Category {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  image       String? @db.VarChar(500)
  sortOrder   Int     @default(0) @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  products Product[]
  
  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(200)
  slug        String  @unique @db.VarChar(200)
  description String  @db.Text
  price       Decimal @db.Decimal(10, 2)
  oldPrice    Decimal? @map("old_price") @db.Decimal(10, 2)
  image       String  @db.VarChar(500)
  images      String[] @default([])
  
  // Product details
  weight      Int?    @db.Integer // in grams
  calories    Int?    @db.Integer
  proteins    Decimal? @db.Decimal(5, 2)
  fats        Decimal? @db.Decimal(5, 2)
  carbohydrates Decimal? @db.Decimal(5, 2)
  
  // Flags
  isActive    Boolean @default(true) @map("is_active")
  isNew       Boolean @default(false) @map("is_new")
  isBestseller Boolean @default(false) @map("is_bestseller")
  
  // Stock
  stockQuantity Int @default(0) @map("stock_quantity")
  
  // Relations
  categoryId String @map("category_id") @db.Uuid
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  
  orderItems OrderItem[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([slug])
  @@index([categoryId])
  @@index([isActive])
  @@index([isNew])
  @@index([isBestseller])
  @@index([price])
  @@map("products")
}

model Order {
  id          String   @id @default(uuid()) @db.Uuid
  orderNumber String   @unique @map("order_number") @db.VarChar(20)
  
  // User info (can be null for guest orders)
  userId      String?  @map("user_id") @db.Uuid
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Contact info
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  email       String   @db.VarChar(255)
  phone       String   @db.VarChar(20)
  address     String   @db.Text
  
  // Order details
  status      OrderStatus  @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod PaymentMethod @default(CASH) @map("payment_method")
  
  // Pricing
  subtotal    Decimal  @db.Decimal(10, 2)
  deliveryFee Decimal  @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  
  // Notes
  customerNote String? @map("customer_note") @db.Text
  adminNote    String? @map("admin_note") @db.Text
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  items OrderItem[]
  
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid()) @db.Uuid
  orderId   String @map("order_id") @db.Uuid
  productId String @map("product_id") @db.Uuid
  
  // Product snapshot
  productName String @map("product_name") @db.VarChar(200)
  productImage String @map("product_image") @db.VarChar(500)
  price     Decimal @db.Decimal(10, 2)
  quantity  Int
  
  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}